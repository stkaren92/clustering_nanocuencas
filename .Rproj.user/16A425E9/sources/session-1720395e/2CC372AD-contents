##### interaction matrix colored by prediction type ####
library(tidyverse)
library(bipartite)

model <- 'knn_gower'
interaction_matrix_knn <- read.csv(paste0('output/interaction_matrix_',
                                          model,
                                          '.csv'),
                                   header = TRUE)
interaction_matrix_observed <- read.csv('data/processed/michoacan/interaction_matrix.csv',
                                        header = TRUE)

df <- interaction_matrix_knn %>%
  pivot_longer(!plant, names_to = "bee", values_to = "interaction_predicted")

df_observed <- interaction_matrix_observed %>%
  dplyr::rename(plant = X) %>% 
  pivot_longer(!plant, names_to = "bee", values_to = "interaction_observed")

df <- df %>% 
  left_join(df_observed, by = c('bee','plant')) %>% 
  mutate(interaction_observed = ifelse(!is.na(interaction_observed),
                                       interaction_observed,
                                       0)) %>% 
  mutate(interaction_observed_bin = ifelse(interaction_observed > 0,1,0)) %>% 
  mutate(diff = interaction_predicted - interaction_observed_bin)

df <- df %>%
  mutate(
    type = case_when(
      interaction_predicted == 1 & interaction_observed_bin == 1 ~ "Verdadero positivo",
      interaction_predicted == 1 & interaction_observed_bin == 0 ~ "Nueva interacción",
      interaction_predicted == 0 & interaction_observed_bin == 1 ~ "Falso Negativo",
      interaction_predicted == 0 & interaction_observed_bin == 0 ~ "Sin interacción"
    )
  )

n <- (sum(df$type=="Verdadero positivo", na.rm = T)+
        sum(df$type=="Falso Negativo", na.rm = T)); n
recall_train <- sum(df$type=="Verdadero positivo", na.rm = T)/n; recall_train

ggplot(df, aes(x = plant, y = bee, fill = as.factor(type))) +
  geom_tile(color = "black") + # Create squares with borders
  scale_fill_manual(values=c("red", "darkblue", "white", "lightblue")) +
  theme_minimal() +
  labs(fill = "") +
  ggtitle(paste(model," recall =",round(recall_train,2))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(size=5),
        aspect.ratio = 1) # Ensure the plot is square
# ggsave(paste0("output/predicted_matrix_",model,".jpeg"), width = 8, height = 8)

# plot observed network
ggplot(df, aes(x = plant, y = bee, fill = as.factor(interaction_observed_bin))) +
  geom_tile(color = "black") + # Create squares with borders
  scale_fill_manual(values=c("white", "black")) +
  theme_minimal() +
  labs(fill = "") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text = element_text(size=5),
        aspect.ratio = 1,
        legend.position = "none") # Ensure the plot is square
# ggsave(paste0("output/observed_matrix.jpeg"), width = 8, height = 8)


interaction_matrix_observed_complete_bin <- df %>% 
  pivot_wider(id_cols = plant, names_from = bee, values_from = interaction_observed_bin,
              values_fill = 0)
interaction_matrix_observed_complete <- df %>% 
  pivot_wider(id_cols = plant, names_from = bee, values_from = interaction_observed,
              values_fill = 0)

networklevel(interaction_matrix_observed_complete %>%
               column_to_rownames(var = names(interaction_matrix_observed_complete)[1]), 
             index = c("connectance","nestedness","NODF","H2"))

networklevel(interaction_matrix_knn %>%
               column_to_rownames(var = names(interaction_matrix_knn)[1]), 
             index = c("connectance","nestedness","NODF","H2"))

networklevel(interaction_matrix_observed %>%
               column_to_rownames(var = names(interaction_matrix_observed)[1]) %>% 
               select(names(interaction_matrix_knn)[-1]), 
             index = c("connectance","nestedness","NODF","H2"))

nulls <- nullmodel(interaction_matrix_knn[-1], N=100, method="r2d")
nulls_metrics <- unlist(sapply(nulls, networklevel, index=c("connectance",
                                                            "nestedness",
                                                            "NODF",
                                                            "H2")))
rowMeans(nulls_metrics)

